---
title: "Reproduce analyses of Brennan and Collins 2015"
author: "Aurelie"
starting date: 19th January 2016
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

# Introduction
This is a reproduction of an experiment presented in the paper *Growth responses of a green alga to multiple environmental drivers*, by Georgina Brennan and Sinead Collins ([the paper on the Nature website](http://www.nature.com/nclimate/journal/v5/n9/full/nclimate2682.html)). Details of the methods are in [the Supplementary Information to the Nature paper](http://www.nature.com/nclimate/journal/v5/n9/extref/nclimate2682-s1.pdf). 


# Authors involved in this reproduction
Lead author was Aurélie Garnier. Ale teamed up too!
All contributions are detailed on GitHub in the commit history.

# Goals for this reproduction
- Learn about Generalized Mixed Models (here, GAM). 
- Personal interest of multiple environmental drivers (Aurélie).


# Known issues
The known issues/ problems with this reproduction are with the prefix "Brennan" ([here](https://github.com/opetchey/RREEBES/issues)). Please add or solved issues there.

#The data
The data are available on the [website](http://datadryad.org/resource/doi:10.5061/dryad.jt1fb) as CSV files, with text document referencing the content of the each CSV file. 

- [**DataDryad_mixed_model_290415.csv**](http://datadryad.org/bitstream/handle/10255/dryad.86868/DataDryad_mixed_model_290415.csv?sequence=1).
Raw data for mixed model analysis, plotting and creating case studies for further analysis. See read me section in r script "mixed_model_DataDryad_290415.r".

- [**All_lines_030515.csv**](http://datadryad.org/bitstream/handle/10255/dryad.86870/All_lines_030515.csv?sequence=1).
.csv file for plotting case study plot using r script "mixed_model_DataDryad_290415.r".

- [**mixed_model_DataDryad_290415.r**](http://datadryad.org/bitstream/handle/10255/dryad.86871/mixed_model_DataDryad_290415.r?sequence=1).
R script for mixed model analysis of raw data supplied and plotting.

- [**Simulation.r**](http://datadryad.org/bitstream/handle/10255/dryad.86872/Simulation.R?sequence=1).
The effect of sampling from a finite number of possible environmental drivers was explored using a simulation written in R.


```{r cleaning_environment}
rm(list=ls())
```

```{r packages}
library(RCurl) # can get URL link
library(plyr) # function ddply
library(ggplot2) # plot
library(lme4)
```

# Get the raw data into R
```{r get_data}
dd <- read.csv(text=getURL("http://datadryad.org/bitstream/handle/10255/dryad.86868/DataDryad_mixed_model_290415.csv?sequence=1"), check.names=FALSE)
str(dd)
```

# Figure 2

## Figure 2a
The figure 2a represents the mean and standard deviation between regimes for each NED.
```{r Fig2a}
mean_per_regime <- ddply(.data=dd, .(regime,treatment), summarise, mean=mean(perDay),sd=sd(perDay))
mean_per_regime <- unique(merge(dd[,c("treatment","NED")], mean_per_regime, by="treatment"))
str(mean_per_regime)

pd <- position_dodge(width=0.3)
shape_treatment <- rep(c(1:6), 16)
lims <- aes(ymin=mean-sd, ymax=mean+sd)

fig2a <- ggplot(data=mean_per_regime, aes(x=NED, y=mean, group=treatment)) +
  geom_errorbar(lims, position = pd, width=0) +
  geom_point(aes(shape=treatment), position = pd, size=2) +
  scale_shape_manual(values=rep(c(1:6),16)) +
  geom_hline(aes(yintercept=mean_per_regime[which(mean_per_regime$NED==0),"mean"]), linetype=2) +
  labs(x="Number of environmental drivers", y="Average cell division rate (per day)") +
  theme_bw()+
  theme(legend.position="none")
fig2a  
```

If problem with position_dodge(), it needs a grouping variable (here, "treatment")

## The need for overlaping and its estimation 

```{r overlap}
ggplot(data=dd, aes(x=NED, y=overlap)) +
  geom_jitter(width=0.2)
```

The need of estimating the overlap of NED between regimes is due to the experimental design. In this study not all possible combination between environmental drivers (which would be 2^8=256 combinations, whereas here 96 combinations were tested). Then, the overlap take into account that some environmental drivers are often involved than others. 
The estimation of overlap was directly in the data sheet. 

The overlap is the number of times that each drivers involved in a specific regime is involved in other regimes, given the total number of possible combinations and the number of combinations realized.

for example in the combination CO2/Herb. The overlap is 0.166667.
The driver "CO2" appears 7 times (in 2-way factorial combinations) and "Herb" appears 2 times. If all possible 2 way combinations were done, there should have 28 regimes but only 15 were done in the experiment. 
((7-1)+(2-1)/28) / 15 = 0.0166667

... but I consistently found a factor of 1/10 between the given overlap and the estimated overlap. It might be a choice from the authors to multiple all the overlap by a factor 10 (which shoud not change the effect)



## The relative fit
This measurement is used to estimate as the effect of each regime. 

```{r relative_fit}

ggplot(data=dd, aes(x=NED,y=relative.fit)) + geom_point() +
  geom_hline(yintercept = mean_per_regime[which(mean_per_regime$NED=="0"),"mean"], colour="red" )+
  geom_hline(yintercept = 1, colour="blue")

test_relative <- dd
test_relative$rel_fit <- test_relative$perDay /mean_per_regime[which(mean_per_regime$NED=="0"),"mean"]

ggplot(data=test_relative, aes(relative.fit, rel_fit)) + geom_point() +
  geom_abline(intercept = 0, slope = 1, colour="red") + 
  facet_wrap(~NED, nrow = 2)
```


## Fig 2b-c-d
```{r mean_per_NED}
mean_per_NED <- ddply(.data=dd, .(NED), summarise, 
                      mean=mean(perDay), sd=sd(perDay))

fig2_base <- ggplot(data=mean_per_NED, aes(x=NED, y=mean)) +
  geom_errorbar(aes(x=NED, ymax=mean+sd, ymin=mean-sd),width=.4) +
  geom_point(size=2) +
  geom_hline(aes(yintercept=0), linetype=2) +
  labs(x="Number of environmental drivers", y="Average cell division rate (per day)") +
  theme_bw()+
  theme(legend.position="none")
fig2_base

```

```{r overall_model}
mod1 <- lmer(perDay ~ NED + overlap + (1|regime) + (1|replicate), REML=TRUE, data=dd)
summary(mod1)
anova(mod1)

mod2<- lmer (perDay ~ NED + overlap + (1|Co2) + (1|Temp) + (1|pH) + (1|P) + (1|Herb) + (1|uv) + (1|ND) + (1|Li) + (1|replicate), dd)
summary(mod2)
anova(mod2)
```


```{r get_main_effect}
# two possibilities to get the main effects

## 1/ using the mean when NED = 1
main_effect_1 <- ddply(subset(dd, NED==1|NED==0), .(treatment,NED), summarise,
                       mean=mean(perDay),
                       sd=sd(perDay),
                       var=var(perDay))

## 2/ using the estimates of the linear model (possible because two levels of each driver, and one of which is the control)
mod_main_effect <- lm(perDay ~ Temp+Co2+Herb+uv+Li+pH+ND+P, subset(dd, NED==1 | NED==0))
summary(mod_main_effect)

est_main_effect <- data.frame(coefficients(mod_main_effect))
est_main_effect$treatment <- gsub("yes","",row.names(est_main_effect))
row.names(est_main_effect) <- NULL
names(est_main_effect)[1] <- "estimate"

## predict the value (Intercept + effect) to compare with the "main_effect_1"
main_effect_2 <- ddply(est_main_effect, .(treatment), summarise, 
                           pred = est_main_effect[1,1] + estimate)

# --> Both method give the same answer
```

Script for the prediction data according to hypothesis

```{r create_estimate_data_frame}
dd_fig2 <- dd[,c(2:12)]

##replace NA for estimates
dd_fig2$Temp <- ifelse(dd_fig2$Temp=="yes",
                   est_main_effect[which(est_main_effect$treatment=="Temp"),"estimate"],
                   NA)
dd_fig2$Co2 <- ifelse(dd_fig2$Co2=="yes",
                   est_main_effect[which(est_main_effect$treatment=="Co2"),"estimate"],
                   NA)
dd_fig2$Herb <- ifelse(dd_fig2$Herb=="yes",
                   est_main_effect[which(est_main_effect$treatment=="Herb"),"estimate"],
                   NA)
dd_fig2$uv <- ifelse(dd_fig2$uv=="yes",
                   est_main_effect[which(est_main_effect$treatment=="uv"),"estimate"],
                   NA)
dd_fig2$Li <- ifelse(dd_fig2$Li=="yes",
                   est_main_effect[which(est_main_effect$treatment=="Li"),"estimate"],
                   NA)
dd_fig2$pH <- ifelse(dd_fig2$pH=="yes",
                   est_main_effect[which(est_main_effect$treatment=="pH"),"estimate"],
                   NA)
dd_fig2$ND <- ifelse(dd_fig2$ND=="yes",
                   est_main_effect[which(est_main_effect$treatment=="ND"),"estimate"],
                   NA)
dd_fig2$P <- ifelse(dd_fig2$P=="yes",
                   est_main_effect[which(est_main_effect$treatment=="P"),"estimate"],
                   NA)
dd_fig2 <- unique(dd_fig2)


```

```{r models}
### comparative model
# N(exp) is equal to the most dominant individual environmental driver relative to the control (1 - N(obs))
### additive model
# N(exp) is the sum effects of all individuals drivers present in the regime when experienced alone
### multiplicative model
# N(exp) is the product for N(obs) for each of the drivers present in the regime when they are experienced alone (at NED=1)

mean_control <- main_effect_1[which(main_effect_1$NED==0),"mean"]

dd_fig2_pred <- ddply(dd_fig2, .(treatment,regime,NED),  function(df){
  
  #df <- unique(subset(dd_fig2, treatment=="Temp"))
  
  if(df$NED==0) {
    comparative=mean_control;
    additive=mean_control;
    multiplicative=mean_control;
  }
 
  if(df$NED!=0) {
    dom_effect = names(df)[which(abs(df[,c(4:11)])==max(abs(df[,c(4:11)]),na.rm=T) )+3] ;
    comparative = mean_control + df[,dom_effect];
    additive = mean_control + sum(df[,c(4:11)], na.rm=TRUE);
    multiplicative = prod(mean_control+df[,c(4:11)], na.rm=TRUE)
  }
  
  return(data.frame(comparative, additive, multiplicative))
})


mean_pred_per_NED <- ddply(dd_fig2_pred, .(NED), summarise,
                           mean_comparative = mean(comparative),sd_comparative = sd(comparative),
                           mean_additive = mean(additive), sd_additive=sd(additive),
                           mean_multiplicative = mean(multiplicative), sd_multiplicative = sd(multiplicative))

```

```{r fig2_models}

fig2b_comparative <- fig2_base + geom_point(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, y=mean_comparative), color="red ",shape=2, size=3) + geom_errorbar(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, ymin=mean_comparative-sd_comparative, ymax=mean_comparative+sd_comparative), color="red")
fig2b_comparative

fig2c_multiplicative <- fig2_base + geom_point(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, y=mean_multiplicative), color="red ",shape=2, size=3)+ geom_errorbar(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, ymin=mean_multiplicative-sd_multiplicative, ymax=mean_multiplicative+sd_multiplicative), color="red")
fig2c_multiplicative

fig2d_additive <- fig2_base + geom_point(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, y=mean_additive), color="red ",shape=2, size=3)+ geom_errorbar(inherit.aes = F, data=mean_pred_per_NED, aes(x=NED, ymin=mean_additive-sd_additive, ymax=mean_additive+sd_additive), color="red")
fig2d_additive
```


# Figure 3
The figure 3 represents the population growth rates of C. reinhardtii in test environmnents containing high CO2, low pH, and high temperature.
```{r fig3_select_data}
subsetA_fig3 <- subset(dd, Co2=="yes" & Temp=="yes" & pH=="yes")
subsetB_fig3 <- subset(dd, treatment=="Co2" | treatment=="Temp" | treatment=="Ph" | treatment=="Co2/Ph" | treatment=="Co2/Temp" | treatment=="Temp/Ph")

subset_fig3 <- rbind(subsetB_fig3, subsetA_fig3)
unique(subset_fig3$treatment)
```

Estimate the mean and the standard deviation for each regime, for the subset of the data set.
```{r mean_per_regime_subset}
mean_per_regime_subset <- ddply(.data=subset_fig3, .(regime,treatment), summarise, mean=mean(perDay),sd=sd(perDay))
mean_per_regime_subset <- unique(merge(dd[,c("treatment","NED")], mean_per_regime_subset, by="treatment"))
str(mean_per_regime_subset)

pd <- position_dodge(width=0.3)
lims <- aes(ymin=mean-sd, ymax=mean+sd)
```


```{r plot_fig3}
ggplot(data=mean_per_regime_subset, aes(x=NED, y=mean, group=treatment)) +
  geom_errorbar(lims, position = pd, width=0) +
  geom_point(aes(shape=treatment), position = pd, size=2) + geom_line()+
  scale_shape_manual(values=rep(c(1:6),3)) +
  geom_hline(aes(yintercept=mean_per_regime[which(mean_per_regime$NED==0),"mean"]), linetype=2) +
  labs(x="Number of environmental drivers", y="Average cell division rate (per day)") +
  theme_bw()+
  theme(legend.position="none")
```

Add lines between the treatments. The lines represent the addition of a perturbation to a regime (i.e., combination of multiple perturbations). For example, a line will link the treatment "Co2" with "Co2/Temp" to highlight the addition of temperature treatment. The estimation of means and standard deviations for each treatment were stored in the dataset "line".
```{r add_line}
line <- read.csv(text=getURL("http://datadryad.org/bitstream/handle/10255/dryad.86870/All_lines_030515.csv?sequence=1"), check.names=FALSE)
line <- unique(merge(dd[,c("treatment","NED")], line, by="treatment"))
line$group <- as.factor(line$group)
str(line)
```

```{r plot_fig3_with_lines}
fig3 <- ggplot() +
  geom_point(data=mean_per_regime_subset, aes(x=NED, y=mean, fill=treatment), size=4, shape=21) +
  geom_errorbar(data=mean_per_regime_subset, aes(x=NED, ymin=mean-sd, ymax=mean+sd), width=0) +
    geom_line(data = subset(line, group=="1"), aes(x = NED, y = mean), linetype = "solid",col="purple") +
    geom_line(data = subset(line, group=="2"), aes(x = NED, y = mean), linetype = "solid",col="orange") +
    geom_line(data = subset(line, group=="3"), aes(x = NED, y = mean), linetype = "dashed",col="purple") +
    geom_line(data = subset(line, group=="4"), aes(x = NED, y = mean), linetype = "dashed",col="orange") +
    geom_line(data = subset(line, group=="5"), aes(x = NED, y = mean), linetype = 1,col="black") +
    geom_line(data = subset(line, group=="6"), aes(x = NED, y = mean), linetype = 2,col="black") +
    geom_line(data = subset(line, group=="7"), aes(x = NED, y = mean), linetype = 3,col="black") +
    geom_line(data = subset(line, group=="8"), aes(x = NED, y = mean), linetype = 4,col="black") +
    geom_line(data = subset(line, group=="9"), aes(x = NED, y = mean), linetype = 5,col="black") +
    geom_line(data = subset(line, group=="10"), aes(x = NED, y = mean), linetype = 6,col="black")+
    annotate("text",  x = 4.25, y = 0.65, label = "+ LI")+
    annotate("text",  x = 5.25, y = 0.67, label = "+ UV")+
    annotate("text",  x = 6.25, y = 0.45, label = "+ ND")+
    annotate("text",  x = 7.25, y = 0.13, label = "+ P")+
    annotate("text",  x = 5.25, y = 0.30 , label = "+ Herb")+
    annotate("text",  x = 6.25, y = 0.29, label = "+ UV")+
    annotate("text",  x = 7.25, y = 0.30, label = "+ ND")+
    annotate("text",  x = 7.25, y = 0.46, label = "+ P")+
    annotate("text",  x = 7.25, y = 0.38, label = "+ Herb")+
  scale_shape_manual(values=rep(c(1:6),3)) +
  geom_hline(aes(yintercept=mean_per_regime[which(mean_per_regime$NED==0),"mean"]), linetype=2) +
  labs(x="Number of environmental drivers", y="Average cell division rate (per day)") +
  theme_bw()+
  theme(legend.position="none")
fig3

```



