---
title: "Reproduction of Catastrophic shifts in ecosystems, Scheffer et al, 2001, Nature"
author: "Owen Petchey, Colette Ward, Aur√©lie Garnier"
date: "21 July 2016"
output: html_document
---

# Introduction

The paper describes how smooth changes in environmental conditions can create drastic / catastrophic changes in ecosystem state. These changes can display hysteresis, whereby responses to changing environmental conditions strongly depend on historical events. The initial purpose of this reproduction is to use the model in Box 1, described as a minimal model of an ecosystem showing hysteresis, to create versions of figures 1, 2, and 3. Some times series of dynamics might also be nice.

# A minimal model of an ecosystem showing hysteresis

$\frac{dx}{dt} = a - bx + rf(x)$

$x$ is an "unwanted" ecosystem property.
$a$ is an environmental factor that "promotes" $x$.
$b$ is the rate of decay of $x$.
$r$ is the rate at which $x$ recovers, as a function of $x$.

"For a lake, one can think of $x$ as nutrients suspended in phytoplankton causing turbidity, of $a$ as nutrient loading, and $b$ as nutrient removal rate, and of $r$ as internal nutrient recycling. For desertification, one could interpret $x$ as barren soil, $a$ as vegetation destruction, $b$ as recolonization of barren soil by plants and $r$ as erosion by wind and runoff."

Hysteresis and alternative stable states can occur if $f(x)$ is a function with a threshold, e.g. the hill function:

$f(x) = \frac{x^p}{x^p + h^p}$

```{r, echo=FALSE}
# here we should write and test the functions that implement this model

dx_dt <- function(x, a, b, r, p, h) {
  a - b*x + r*f_of_x(x, p, h)
}

f_of_x <- function(x, p, h) {
  x^p / (x^p + h^p)
}

```

## Explore f(x)
```{r, echo = FALSE}

# plot f_of_x vs x:
x <- seq(0, 10, 0.1)

plot(x, f_of_x(x, p = 1.1, h = 5), type = "l", ylim = c(0,1))
lines(x, f_of_x(x, p = 10, h = 5), type = "l")
lines(x, f_of_x(x, p = 100, h = 5), type = "l")


```



# Figure 1: environment - state relationships

Three relationships between environmental conditions ($a$) and ecosystem state ($x$), going from smooth relationship, to threshold relationship, to folded relationship. Perhaps show a time series for each of these.

```{r, echo=FALSE}
library(deSolve)
parameters <- c(a = 1, b = 1, r = 1, p = 1.1, h = 5)
state <- c(x = 1)

model <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), {
    dx <- dx_dt(x, a, b, r, p, h)
    list(c(dx))
  })
}

times <- seq(0, 100, by = 0.1)

out <- ode(y = state, times = times, func = model, parms = parameters)
head(out)
```


```{r}
# now do with a range of values of a and plot
as <- seq(0, 2, 0.01)
#ps <- seq(0, 100, 1)
ps <- c(0, 5, 10, 50, 100)

expt <- expand.grid(as=as, ps=ps)


library(rootSolve)
roots <- uniroot.all(dx_dt, interval=c(0,10),
        a=1, b=1, r=1, p=100, h=1.5)

library(purrr)
library(dplyr)
library(tidyr)
library(broom)
library(ggplot2)


 
results <- expt %>%
  group_by(as, ps) %>%
  do(roots = as.data.frame(uniroot.all(dx_dt, interval=c(0,10),
        a=.$as, b=1, r=1, p=.$ps, h=1.5)))
results <-unnest(results)
names(results) <- c("as", "ps", "roots")
results

qplot(as, roots, data=results, col=as.factor(ps), geom="point")



```

# now do with a range of values of a and plot
as <- seq(0, 10, 2)
ps <- seq(0, 10, 5)
expt <- expand.grid(as=as, ps=ps)

## set other modelling parameters etc
out_times <- seq(0, 100, 0.1)
other.things <- list(b=1, r=1, h=5,
                     X_0=1, out_times=out_times)


expt
```



# Figure 2: shifting between states

A folded relationship between environmental conditions ($a$) and ecosystem state ($x$), with two ways of shifting between the alternate states. Again, perhaps show a time series?

# Figure 3: basins of attraction

