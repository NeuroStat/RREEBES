---
title: "Reproduction of Catastrophic shifts in ecosystems, Scheffer et al, 2001, Nature"
author: "Owen Petchey, Colette Ward, Aur√©lie Garnier"
date: "21 July 2016"
output: html_document
---

```{r, echo=F, message=FALSE, warning=FALSE}
library(knitr)
opts_knit$set(cache=TRUE, autodep=TRUE)
library(purrr)
library(dplyr)
library(broom)
library(ggplot2)
library(rootSolve)
library(numDeriv)
library(tidyr)
library(deSolve)
```

```{r}
# set some global parameter values
a = 1
b = 1
r = 1
h = 1
p = 1
ps <- c(2, 5, 10, 20, 50)
xs <- seq(0, 2, 0.01)
```



# Introduction

The paper describes how smooth changes in environmental conditions can create drastic / catastrophic changes in ecosystem state. These changes can display hysteresis, whereby responses to changing environmental conditions strongly depend on historical events. The initial purpose of this reproduction is to use the model in Box 1, described as a minimal model of an ecosystem showing hysteresis, to create versions of figures 1, 2, and 3. Some times series of dynamics might also be nice.

# A minimal model of an ecosystem showing hysteresis

$\frac{dx}{dt} = a - bx + rf(x)$

$x$ is an "unwanted" ecosystem property.
$a$ is an environmental factor that "promotes" $x$.
$b$ is the rate of decay of $x$.
$r$ is the rate at which $x$ recovers, as a function of $x$.

"For a lake, one can think of $x$ as nutrients suspended in phytoplankton causing turbidity, of $a$ as nutrient loading, and $b$ as nutrient removal rate, and of $r$ as internal nutrient recycling. For desertification, one could interpret $x$ as barren soil, $a$ as vegetation destruction, $b$ as recolonization of barren soil by plants and $r$ as erosion by wind and runoff."

Hysteresis and alternative stable states can occur if $f(x)$ is a function with a threshold, e.g. the hill function:

$f(x) = \frac{x^p}{x^p + h^p}$

```{r, echo=FALSE}
# here we should write and test the functions that implement this model

dx_dt <- function(x, a, b, r, p, h) {
  a - b*x + r*f_of_x(x, p, h)
}

f_of_x <- function(x, p, h) {
  x^p / (x^p + h^p)
}

dx_dt2 <- function(x, p=1) {
  a - b*x + r * x^p / (x^p + h^p)
}


```

## Explore f(x)
```{r, echo = FALSE}

# plot f_of_x vs x:
expt1 <- expand.grid(ps=ps, xs=xs)
results1 <- mutate(expt1, f_of_x=f_of_x(x=xs, p=ps, h=h))

qplot(xs, f_of_x, data=results1, col=as.factor(ps), geom="path") +
  xlab("System state (X)") +
  ylab("Value of self feedback (f(X))") +
  scale_colour_discrete(guide = guide_legend(title = "Nonlinearity of self feedback (p)"))


```



# Figure 1: environment - state relationships

Relationships between environmental conditions ($a$) and ecosystem state ($x$), going from smooth relationship, to threshold relationship, to folded relationship.


```{r, echo=FALSE}
# set the range of values of a, for the x-axis of plot
as <- seq(0, 1, 0.001)

# set the values of p (non-linearity of self feedback)
#ps <- seq(0, 100, 1)
#ps <- c(2, 5, 10, 20, 50) ## now defined previously


#plot(xs, dx_dt(xs, a=0.5, b=1, r=1, h=1, p=10))
#abline(h=0)

## calculate equilibria for all combinations
expt2 <- expand.grid(as=as, ps=ps)
results2 <- expt2 %>%
  group_by(as, ps) %>%
  do(roots = as.data.frame(uniroot.all(dx_dt, interval=c(0,10),
        a=.$as, b=b, r=r, p=.$ps, h=h))) %>%
  tidyr::unnest()
names(results2) <- c("as", "ps", "roots")
results2 <- arrange(results2, ps, roots)

results2$stability <- ifelse(grad(dx_dt, x=results2$roots, a=results2$as, b=b, r=r, p=results2$ps, h=h)<0, "Stable", "Unstable")

qplot(as, roots, data=filter(results2, stability=="Stable", roots<1),
      col=as.factor(ps), geom="path") +
  geom_path(data=filter(results2, stability=="Stable", roots>1)) +
  geom_path(data=filter(results2, stability=="Unstable"), linetype="dashed") +
  xlab("Environmental condition (a)") +
  ylab("Equilibrium state (X)") +
  scale_colour_discrete(guide = guide_legend(title = "Nonlinearity of self feedback (p)")) +
  scale_linetype_manual(values=c("Yes"="solid", "No"="Dashed")) +
  ylim(0,2)
  


```


# Figure 2: shifting between states

A folded relationship between environmental conditions ($a$) and ecosystem state ($x$), with two ways of shifting between the alternate states.



```{r, echo=FALSE}

this.p <- ps[3]
parameters <- c(a = a, b = b, r = r, p = this.p, h = h)
state <- c(x = 0.1)

model <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), {
    dx <- dx_dt(x, a_forcing2(t), b, r, p, h)
    list(c(dx), a=a_forcing2(t))
  })
}

times <- seq(0, 200, by = 0.1)

a_forcing1 <- matrix(ncol=2, byrow=T, data=c(0,0, mean(times), 1, max(times), 0))
a_forcing2 <- approxfun(x = a_forcing1[,1], y = a_forcing1[,2], method = "linear", rule = 2)

out <- as.data.frame(ode(y = state, times = times, func = model, parms = parameters))

ggplot(out, aes(x=time, y=x)) + 
  geom_line(aes(y=a), col="green", size=3) +
  geom_line() +
  ylab("Ecosystem state (X)") +
  xlab("Time")


```

```{r, echo=FALSE}
ggplot(out, aes(x=a, y=x)) +
  geom_path(data=filter(results2, ps==this.p), aes(x=as, y=roots), col="lightblue", size=5) +
  geom_path() +
  xlab("Environmental condition (a)") +
  ylab("Ecosystem state (X)")
  
```



# Figure 3: basins of attraction

```{r, echo=FALSE}
#gr <- dx_dt(xs, a=0.25, b=b, r=r, p=ps[3], h=h)
#plot(xs, (-1*cumsum(gr)-min(-1*cumsum(gr))), type="l",
#     ylab=" ", xlab="Ecosystem state (X)")
#gr1 <- dx_dt(xs, a=0.5, b=b, r=r, p=ps[3], h=h)
#lines(xs, (-1*cumsum(gr1)-min(-1*cumsum(gr1))), type="l")

as <- seq(0, 1, 0.1)
as <- c(0.2, 0.35, 0.45, 0.5)
expt3 <- expand.grid(as=as, xs=xs)
results3 <- expt3 %>%
  mutate(grad=dx_dt(x=xs, a=as, b=b, r=r, p=ps[3], h=h)) %>%
  arrange(as, xs) %>%
  group_by(as) %>%
  mutate(height=(-1*cumsum(grad)-min(-1*cumsum(grad))))
  
ggplot(results3, aes(x=xs, y=height, col=as.factor(as))) +
  geom_line(size=2) +
  ylab("Basin height") +
  xlab("Ecosystem state (X)") +
  scale_colour_discrete(guide = guide_legend(title = "Environmental condition (a)"))
  


```



