---
title: "Hsieh_et_al_2008_repro"
output: html_document
---

# Introduction:

Hsieh et al. 2008, American Naturalist propose a method to detect non-linearity in ecological time series using the simplex and s-map projections developed by Sugihara and co-workers. Generally, non-linear time series analysis requires long-time series to detect signals. The approach by Hsieh et al. combines individual time series of ecologically similar species into one long time series to which simplex and s-maps can be applied (termed *Dewdrop regression* by the authors). To illustrate their approach, a five species competition model was used to generate time series and the ability of the method to get back the original parameter values of the simulation tested under various levels of noise and lengths of the time series.

The goals for this reproduction are:
* understanding simplex and s-maps as forecasting tools using the recently released rEDM package.
* understand the approach taken to combine several short time series into one long time series to detect non-linearity and make useful forecasts
* set up a simulation model of multi-species competition

# Step 1: Simulate 5 species dynamics:

First we reproduced the dynamics of the 5 species community as follows:

* a multispecies competition model based on the logistic map
* all alphas set to 0.05
* growth rate r is 3.57 (just below the chaotic regime)
* 15% process noise noise was added to the time series (to the alphas)
* additionally, 5% observation noise was added to the generated time series
* time series of abundance for 1000 steps generated for each species

The following R code implements the simulation model:
```{r, eval=T}
# This code implements a multispecies competition model based on the logistic map (https://en.wikipedia.org/wiki/Logistic_map)
# the equilibrium density depends on the growth rate (steady state at values between 1 and 2, extinction below 1, chaos > 3.7, fluctuations > 3)

# set seed
set.seed(190981)

## Specify the number of species
S <- 5

#growth rate in the eight-mode oscillation regime below the threshold to chaos
r <- 3.57

# specify alphas
a <- 0.05

# simulate 1000 time steps
t=seq(1,1000, by=1)

# specify matrix to hold results
N <- matrix(nrow=S, ncol=length(t))

# set initial conditions randomly
N[,1] <- runif(S)

# simulate dynamics using the discrete logistic growth model; add process noise at the end
for (i in 1:(length(t)-1)){
  
  for (j in 1:5){

    N[j,i+1] = (r * N[j,i] * (1- N[j,i]) - a*sum(N[-j,i]) ) * runif(1,0.85,1.15)
    
  }
}

# add some observation noise to time series
N <- N * runif(length(N), 0.95, 1.05)

# plot results
matplot(t,t(N[1:S,]), "l",ylim=c(0,1), xlim=c(0,100),col=2:5)


output <- as.data.frame(t(N[1:S,]))
names(output) <- paste0("species ", 1:S)

# check for correlation in abundances
plot(output$`species 1`, output$`species 5`)

write.csv(output, "/Users/Frank/Documents/Git projects/RREEBES/Hsieh_et_al_2008/data/5sp_comp_sim_data.csv", row.names=F)

```

Next we try to reproduce figure 1 from the publication:
```{r}
five_sp_comp <- read.csv("/Users/Frank/Documents/Github projects/RREEBES/Hsieh_et_al_2008/data/5sp_comp_sim_data_CA_code.csv")
names(five_sp_comp) <- c("time", paste0("species.", 1:5))
#five_sp_comp$time <- seq(1,1000)

# fig 1 A
plot(five_sp_comp[,3], five_sp_comp[,5], xlim=c(0,1.1), ylim=c(0,1.1))

# fit AR(4) model
ar_mod <-  ar(as.ts(five_sp_comp[,c(5)]), FALSE, 4)
str(ar_mod)

ar_mod$ar

sp3_ar_prediction <- vector("numeric", 1000)
# predict species 3 based on species 5
for (t in 5:1000){

sp3_ar_prediction[t] = ar_mod$x.mean + ar_mod$ar[1] * five_sp_comp[(t-1),3] + ar_mod$ar[2] * five_sp_comp[(t-2),3]  + ar_mod$ar[3] * five_sp_comp[(t-3),3] + ar_mod$ar[4] * five_sp_comp[(t-4),3]

}

plot(sp3_ar_prediction, five_sp_comp[,3])
abline(a=1, b=1)
```

# Step 2: Apply simplex projection from rEDM package to simulated time series

Predict last 15 time steps of species 1 based on previous 985 time steps of same species.

```{r, echo=FALSE}
# now load our simulated time series

#load rEDM package
library(rEDM)

simplex_mod_stats_sp5_1 <- simplex(five_sp_comp$species.5, lib = c(1, 500), pred = c(500, NROW(five_sp_comp$species.5)),
                norm_type = c("L2 norm"), E = 1:10,
                tau = 1, tp = 1, num_neighbors = "e+1", stats_only = T,
                exclusion_radius = NULL, epsilon = NULL, silent = FALSE)

# check number of embedding dimensions
plot(simplex_mod_stats_sp5_1$E, simplex_mod_stats_sp5_1$rho, type="l", xlab = "Embedding dimension (E)", ylab="Forecast skill (rho)")

# look at actual forecasting skill (we have to refit the model and set stats_only to FALSE) when predicting species 1 with data from species 1
simplex_mod_pred_sp5_2 <- simplex(five_sp_comp$species.5, lib = c(1, 500), pred = c(500, NROW(five_sp_comp$species.5)),
                norm_type = c("L2 norm"),  E = 1:10,
                tau = 1, tp = 1, num_neighbors = "e+1", stats_only = F,
                exclusion_radius = NULL, epsilon = NULL, silent = FALSE)

sp5_observations  <- simplex_mod_pred_sp5_2[[3]]$model_output$obs
sp5_predictions  <- simplex_mod_pred_sp5_2[[3]]$model_output$pred

head(simplex_mod_pred_sp5_2[[3]]$model_output$time)

# compare data with predictions visually
plot(five_sp_comp$time, five_sp_comp$species.5, "l", ylim=c(0,1), xlim = c(900,1000))
par(new=T)
plot(simplex_mod_pred_sp5_2[[3]]$model_output$time, simplex_mod_pred_sp5_2[[3]]$model_output$pred, "l", lty = 2, col="red", ylim=c(0,1), xlim = c(900,1000))

plot(sp5_observations, sp5_predictions, "p", lty = 2, col="red", ylim=c(0,1), xlim=c(0,1))
abline(0,1)


```


# Step 3: apply s-maps to simulated time series with best embedding dimension as determined by simplex

```{r}
# now use smap with E dimensions (identified with Simplex)
smap_out <- s_map(five_sp_comp$species.5, lib = c(1, 500), pred = c(501,NROW(five_sp_comp$species.5)), stats_only = T,
                  norm_type = c("L2 norm"), E = 3)
smap_out

# plot theta against forecasting skill
plot(smap_out$theta, smap_out$rho, type="l", xlab = "Non-linearity", ylab="Forecast skill (rho)")

smap_pred <- s_map(five_sp_comp$species.5, lib = c(1, 500), pred = c(501,NROW(five_sp_comp$species.5)), stats_only = F,
                  norm_type = c("L2 norm"), E = 4, theta = 4)

sp5_observations  <- smap_pred[[1]]$model_output$obs
sp5_predictions  <- smap_pred[[1]]$model_output$pred

plot(sp5_observations, sp5_predictions)
abline(0,1)
```



```{r}
# predict species 3 based on embeddings in species 5
block_data <- five_sp_comp[,c(1,4,6)]
n <- NROW(block_data$species.5)
block_data$species.5m1 <- c(NA, block_data$species.5[-n])
block_data$species.5m2 <- c(NA, block_data$species.5m1[-n])
block_data$species.5m3 <- c(NA, block_data$species.5m2[-n])
block_data$species.5m4 <- c(NA, block_data$species.5m3[-n])
block_data$species.5m5 <- c(NA, block_data$species.5m4[-n])
block_data$species.5m6 <- c(NA, block_data$species.5m5[-n])
block_data$species.5m7 <- c(NA, block_data$species.5m6[-n])
block_data$species.5m8 <- c(NA, block_data$species.5m7[-n])

# Embed <- function(X, dimension=4) {
#   E_X <- matrix(NA, length(X)-dimension, dimension)
#   for(i in 1:dimension)
#     E_X[,i] <- X[(1+i-1):(length(X)-dimension+i-1)]
#   E_X
# }
# 
# embed_sp5 <- Embed(five_sp_comp[,c(5)], dimension=10)
# names(embed_sp5) <- paste0("embed",1:10)
# data.frame(five_sp_comp$species.3, embed_sp5)

block <- block_lnlp(block_data, lib = c(1, 500), pred = c(500,NROW(block_data)),
  norm_type = c("L2 norm"), 
  method = c("s-map"), tp = 1, num_neighbors = "e+1",
  columns = c(4:7), target_column = c("species.3"), stats_only = F, first_column_time = T)

sp3_observations  <- block[[1]]$model_output$obs
sp3_predictions  <- block[[1]]$model_output$pred

plot(sp3_observations, sp3_predictions, ylim=c(-1.5,1.5))
abline(a=0,b=1)
str(block)
```





```{r, state-space}
Embed <- function(X, dimension=4) {
  E_X <- matrix(NA, length(X)-dimension, dimension)
  for(i in 1:dimension)
    E_X[,i] <- X[(1+i-1):(length(X)-dimension+i-1)]
  E_X
}

for (i in 1:2){

embed_sp5 <- Embed(five_sp_comp[,c(i)], dimension=3)
colnames(embed_sp5) <- paste0("embed",1:3)

library(plot3D)

lines3D(x = embed_sp5[,1],
       y = embed_sp5[,2],
       z = embed_sp5[,3], colvar=NULL, col="blue", add=T)
lines3D(x = embed_sp5[,1],
       y = embed_sp5[,2],
       z = embed_sp5[,3], colvar=NULL, col="red", add=T) 
}

```

